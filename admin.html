<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†å“¡æ§åˆ¶å°</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f8f9fa; }
    h2 { color: #333; }
    textarea, input, select {
      width: 100%; padding: 8px; margin: 6px 0 12px; border: 1px solid #ccc;
      border-radius: 4px; font-size: 1em;
    }
    button {
      padding: 8px 12px; margin: 4px 4px 12px 0;
      background: #007bff; color: white; border: none; border-radius: 4px;
      cursor: pointer;
    }
    button.danger { background: #dc3545; }
    #log { white-space: pre-wrap; background: #fff; border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>ğŸ” ç®¡ç†å“¡æ§åˆ¶å°</h2>
  <div id="admin-section" style="display: none;">
    <h3>ğŸ“¢ å…¬å‘Šæ¬„</h3>
    <textarea id="announcement"></textarea>
    <button onclick="updateAnnouncement()">å„²å­˜å…¬å‘Š</button>

    <h3>ğŸ—‚ï¸ ç¾¤çµ„ç®¡ç†</h3>
    <input type="text" id="new-group" placeholder="æ–°å¢ç¾¤çµ„åç¨±..." />
    <button onclick="createGroup()">æ–°å¢ç¾¤çµ„</button>

    <h4>é¸æ“‡ç¾¤çµ„ä»¥æŸ¥çœ‹èŠå¤©è¨˜éŒ„ï¼š</h4>
    <select id="group-select"></select>
    <button onclick="loadMessages()">è¼‰å…¥è¨Šæ¯</button>
    <button class="danger" onclick="deleteGroupMessages()">åˆªé™¤æ­¤ç¾¤çµ„è¨Šæ¯</button>

    <h3>ğŸ’¬ èŠå¤©è¨˜éŒ„</h3>
    <div id="log">è«‹å…ˆé¸æ“‡ç¾¤çµ„</div>

    <h3>ğŸ§¹ å…¨éƒ¨æ¸…é™¤</h3>
    <button class="danger" onclick="deleteAllMessages()">âš ï¸ æ¸…é™¤æ‰€æœ‰ç¾¤çµ„è¨Šæ¯</button>
  </div>
  <div id="auth-section">
    <p>æ­£åœ¨ç™»å…¥ä¸­...</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
    import {
      getDatabase, ref, get, set, remove, update, onValue, push
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    // âœ… è«‹ç¢ºèªä½ çš„ firebaseConfig ç„¡èª¤
    const firebaseConfig = {
      apiKey: "AIzaSyBGwhduNhNnWVGv90NxYo24VqxBvTOtWdY",
      authDomain: "china-trip-chat.firebaseapp.com",
      databaseURL: "https://china-trip-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "china-trip-chat",
      storageBucket: "china-trip-chat.appspot.com",
      messagingSenderId: "745385089997",
      appId: "1:745385089997:web:665125e7a74bac1cdc4284"
    };

    const adminUIDs = [
      "W8xAOxDaicWIxhFDJJfxsBVg3LH2
    ];

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const announcementEl = document.getElementById("announcement");
    const groupSelect = document.getElementById("group-select");
    const logEl = document.getElementById("log");

    onAuthStateChanged(auth, user => {
      if (!user) {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(e => alert("ç™»å…¥å¤±æ•—ï¼š" + e.message));
        return;
      }

      console.log("ç™»å…¥ UIDï¼š", user.uid);

      if (!adminUIDs.includes(user.uid)) {
        alert("ä½ ä¸æ˜¯ç®¡ç†å“¡ï¼Œç„¡æ³•ä½¿ç”¨æ­¤é é¢ï¼");
        document.body.innerHTML = "<h2>ğŸš« ç„¡æ¬Šé™</h2>";
        return;
      }

      document.getElementById("auth-section").style.display = "none";
      document.getElementById("admin-section").style.display = "block";

      loadAnnouncement();
      loadGroupList();
    });

    function loadAnnouncement() {
      const annRef = ref(db, "system/announcement");
      onValue(annRef, (snap) => {
        announcementEl.value = snap.val() || "";
      });
    }

    function updateAnnouncement() {
      const text = announcementEl.value.trim();
      set(ref(db, "system/announcement"), text).then(() => {
        alert("å…¬å‘Šå·²æ›´æ–°");
      });
    }

    function loadGroupList() {
      get(ref(db, "groups")).then(snap => {
        groupSelect.innerHTML = "";
        if (snap.exists()) {
          Object.keys(snap.val()).forEach(group => {
            const opt = document.createElement("option");
            opt.value = group;
            opt.textContent = group;
            groupSelect.appendChild(opt);
          });
        }
      });
    }

    function loadMessages() {
      const group = groupSelect.value;
      if (!group) return;
      get(ref(db, `groups/${group}/messages`)).then(snap => {
        if (!snap.exists()) {
          logEl.textContent = "(æ­¤ç¾¤çµ„æ²’æœ‰è¨Šæ¯)";
          return;
        }
        let out = "";
        snap.forEach(msg => {
          const val = msg.val();
          out += `[${new Date(val.timestamp).toLocaleString()}] ${val.name}: ${val.text}\n`;
        });
        logEl.textContent = out;
      });
    }

    function deleteGroupMessages() {
      const group = groupSelect.value;
      if (!group) return;
      if (!confirm(`ç¢ºèªè¦åˆªé™¤ã€Œ${group}ã€çš„æ‰€æœ‰è¨Šæ¯ï¼Ÿ`)) return;
      remove(ref(db, `groups/${group}/messages`)).then(() => {
        alert("å·²æ¸…é™¤");
        logEl.textContent = "";
      });
    }

    function deleteAllMessages() {
      if (!confirm("âš ï¸ ç¢ºèªè¦åˆªé™¤æ‰€æœ‰ç¾¤çµ„çš„è¨Šæ¯å—ï¼Ÿ")) return;
      get(ref(db, "groups")).then(snap => {
        const updates = {};
        snap.forEach(group => {
          updates[`groups/${group.key}/messages`] = null;
        });
        update(ref(db), updates).then(() => alert("æ‰€æœ‰è¨Šæ¯å·²æ¸…ç©º"));
      });
    }

    function createGroup() {
      const name = document.getElementById("new-group").value.trim();
      if (!name) return;
      set(ref(db, `groups/${name}`), { createdAt: Date.now() }).then(() => {
        alert("ç¾¤çµ„å·²å»ºç«‹");
        loadGroupList();
      });
    }
  </script>
</body>
</html>
