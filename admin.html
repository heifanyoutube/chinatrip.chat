<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>聊天室管理員控制台</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      height: 100vh;
      background: #f0f2f5;
    }
    header {
      background: #333;
      color: white;
      padding: 12px;
      font-size: 1.4em;
      text-align: center;
    }
    main {
      flex: 1;
      display: flex;
      padding: 10px;
      gap: 20px;
      overflow: hidden;
    }
    section {
      background: white;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      overflow-y: auto;
    }
    #login-section {
      max-width: 300px;
      margin: auto;
      padding: 30px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      text-align: center;
    }
    #login-section input[type=password] {
      width: 80%;
      padding: 8px;
      margin: 10px 0 20px;
      font-size: 1em;
    }
    #login-section button {
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      background-color: #4caf50;
      border: none;
      color: white;
      border-radius: 4px;
    }
    #login-error {
      color: red;
      margin-top: 8px;
    }
    #admin-panel {
      display: none;
      height: 100%;
      width: 100%;
      flex-direction: column;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    #top-bar h2 {
      margin: 0;
    }
    #logout-btn {
      background: #d33;
      border: none;
      color: white;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
    }
    #content {
      display: flex;
      gap: 20px;
      flex: 1;
      overflow: hidden;
    }
    #groups, #users, #messages, #announcement {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      overflow-y: auto;
      background: white;
    }
    #groups h3, #users h3, #messages h3, #announcement h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    #groups-list, #users-list, #messages-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
      overflow-y: auto;
    }
    #groups-list li, #users-list li, #messages-list li {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button.small-btn {
      background: #f44336;
      border: none;
      color: white;
      font-size: 0.8em;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    #announcement textarea {
      width: 100%;
      height: 100px;
      resize: none;
      font-size: 1em;
      padding: 8px;
      margin-bottom: 6px;
    }
    #announcement button {
      background: #2196F3;
      border: none;
      color: white;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 1em;
      align-self: flex-start;
    }
    #group-add {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
    #group-add input {
      flex: 1;
      padding: 6px;
      font-size: 1em;
    }
    #group-add button {
      padding: 6px 12px;
      font-size: 1em;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Scrollbar styling for better UX */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <header>聊天室管理員控制台</header>

  <div id="login-section">
    <h2>管理員登入</h2>
    <input type="password" id="admin-password" placeholder="請輸入管理員密碼" />
    <br />
    <button id="login-btn">登入</button>
    <div id="login-error"></div>
  </div>

  <div id="admin-panel">
    <div id="top-bar">
      <h2>管理員控制台</h2>
      <button id="logout-btn">登出</button>
    </div>
    <div id="content">
      <section id="groups">
        <h3>聊天室群組</h3>
        <ul id="groups-list"></ul>
        <div id="group-add">
          <input type="text" id="new-group-name" placeholder="新增群組名稱" />
          <button id="add-group-btn">新增群組</button>
        </div>
      </section>

      <section id="users">
        <h3>在線使用者</h3>
        <ul id="users-list"></ul>
      </section>

      <section id="messages">
        <h3>聊天訊息</h3>
        <select id="select-group"></select>
        <ul id="messages-list"></ul>
        <button id="clear-messages-btn" style="margin-top:10px; background:#d33;">清空該群組訊息</button>
      </section>

      <section id="announcement">
        <h3>公告欄</h3>
        <textarea id="announcement-text" placeholder="輸入公告內容..."></textarea>
        <button id="save-announcement-btn">儲存公告</button>
      </section>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import {
    getDatabase, ref, onValue, remove, set
  } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGwhduNhNnWVGv90NxYo24VqxBvTOtWdY",
    authDomain: "china-trip-chat.firebaseapp.com",
    databaseURL: "https://china-trip-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "china-trip-chat",
    storageBucket: "china-trip-chat.appspot.com",
    messagingSenderId: "745385089997",
    appId: "1:745385089997:web:665125e7a74bac1cdc4284"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // 預設管理員密碼
  const ADMIN_PASSWORD = "admin123";

  // DOM Elements
  const loginSection = document.getElementById("login-section");
  const adminPanel = document.getElementById("admin-panel");
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const adminPasswordInput = document.getElementById("admin-password");
  const loginError = document.getElementById("login-error");

  const groupsList = document.getElementById("groups-list");
  const usersList = document.getElementById("users-list");
  const messagesList = document.getElementById("messages-list");
  const selectGroup = document.getElementById("select-group");
  const clearMessagesBtn = document.getElementById("clear-messages-btn");
  const announcementText = document.getElementById("announcement-text");
  const saveAnnouncementBtn = document.getElementById("save-announcement-btn");
  const newGroupNameInput = document.getElementById("new-group-name");
  const addGroupBtn = document.getElementById("add-group-btn");

  let isAdminLoggedIn = false;
  let currentGroup = "";
  let messagesListenerUnsub = null;
  let groupsListenerUnsub = null;
  let usersListenerUnsub = null;
  let announcementListenerUnsub = null;

  // 封鎖清單（用戶 uid）
  let blockedUsers = [];

  function showLoginError(msg) {
    loginError.textContent = msg;
  }

  function clearLoginError() {
    loginError.textContent = "";
  }

  function loginAdmin() {
    const pwd = adminPasswordInput.value.trim();
    if(pwd === ADMIN_PASSWORD){
      isAdminLoggedIn = true;
      loginSection.style.display = "none";
      adminPanel.style.display = "flex";
      clearLoginError();
      initAdminPanel();
    } else {
      showLoginError("密碼錯誤！");
    }
  }

  function logoutAdmin() {
    isAdminLoggedIn = false;
    if(messagesListenerUnsub) messagesListenerUnsub();
    if(groupsListenerUnsub) groupsListenerUnsub();
    if(usersListenerUnsub) usersListenerUnsub();
    if(announcementListenerUnsub) announcementListenerUnsub();

    loginSection.style.display = "block";
    adminPanel.style.display = "none";
    adminPasswordInput.value = "";
    messagesList.innerHTML = "";
    groupsList.innerHTML = "";
    usersList.innerHTML = "";
    selectGroup.innerHTML = "";
    announcementText.value = "";
  }

  loginBtn.onclick = loginAdmin;
  logoutBtn.onclick = logoutAdmin;

  // 初始化管理面板
  function initAdminPanel() {
    loadBlockedUsers();
    loadGroups();
    loadAnnouncement();
    loadUsers();
  }

  // 讀取封鎖用戶清單
  function loadBlockedUsers() {
    const blockedRef = ref(db, "blockedUsers");
    onValue(blockedRef, (snapshot) => {
      blockedUsers = [];
      snapshot.forEach(child => {
        blockedUsers.push(child.key);
      });
    });
  }

  // 讀取群組清單
  function loadGroups() {
    const groupsRef = ref(db, "groups");
    groupsListenerUnsub = onValue(groupsRef, (snapshot) => {
      groupsList.innerHTML = "";
      selectGroup.innerHTML = "";
      snapshot.forEach(child => {
        const groupName = child.key;
        addGroupToUI(groupName);
      });
      // 如果之前沒選擇群組，自動選第一個
      if (!currentGroup && selectGroup.options.length > 0) {
        currentGroup = selectGroup.options[0].value;
      }
      selectGroup.value = currentGroup;
      loadMessages(currentGroup);
    });
  }

  // 加入群組到清單與下拉選單
  function addGroupToUI(groupName) {
    // 列表
    const li = document.createElement("li");
    li.textContent = groupName;

    const delBtn = document.createElement("button");
    delBtn.textContent = "刪除";
    delBtn.className = "small-btn";
    delBtn.onclick = () => {
      if(confirm(`確定刪除群組「${groupName}」？\n將會清除所有該群組資料！`)){
        remove(ref(db, `groups/${groupName}`));
        if(currentGroup === groupName) {
          currentGroup = "";
          messagesList.innerHTML = "";
          selectGroup.value = "";
        }
      }
    };
    li.appendChild(delBtn);
    groupsList.appendChild(li);

    // 下拉選單
    const opt = document.createElement("option");
    opt.value = groupName;
    opt.textContent = groupName;
    selectGroup.appendChild(opt);
  }

  addGroupBtn.onclick = () => {
    const newGroup = newGroupNameInput.value.trim();
    if(!newGroup){
      alert("請輸入群組名稱");
      return;
    }
    set(ref(db, `groups/${newGroup}`), { createdAt: Date.now() })
      .then(() => {
        newGroupNameInput.value = "";
      })
      .catch(err => alert("新增群組失敗：" + err.message));
  };

  // 讀取聊天室訊息
  function loadMessages(groupName) {
    if(messagesListenerUnsub) messagesListenerUnsub();
    messagesList.innerHTML = "";
    if(!groupName) return;

    const messagesRef = ref(db, `groups/${groupName}/messages`);

    messagesListenerUnsub = onValue(messagesRef, (snapshot) => {
      messagesList.innerHTML = "";
      snapshot.forEach(child => {
        const msg = child.val();
        const key = child.key;

        // 顯示訊息，若封鎖使用者則加紅色標示
        const li = document.createElement("li");
        li.textContent = `[${new Date(msg.timestamp).toLocaleString()}] ${msg.name}: ${msg.text}`;
        if(blockedUsers.includes(msg.uid)){
          li.style.color = "red";
          li.title = "此用戶已封鎖";
        }

        // 刪除訊息按鈕
        const delBtn = document.createElement("button");
        delBtn.textContent = "刪除";
        delBtn.className = "small-btn";
        delBtn.onclick = () => {
          if(confirm("確定刪除此訊息？")){
            remove(ref(db, `groups/${groupName}/messages/${key}`));
          }
        };

        li.appendChild(delBtn);
        messagesList.appendChild(li);
      });
    });
  }

  selectGroup.onchange = () => {
    currentGroup = selectGroup.value;
    loadMessages(currentGroup);
  };

  // 清空目前群組訊息
  clearMessagesBtn.onclick = () => {
    if(!currentGroup){
      alert("請先選擇群組");
      return;
    }
    if(confirm(`確定清空群組「${currentGroup}」的所有訊息？`)){
      remove(ref(db, `groups/${currentGroup}/messages`));
    }
  };

  // 讀取在線用戶
  function loadUsers() {
    const usersRef = ref(db, "users");
    usersListenerUnsub = onValue(usersRef, (snapshot) => {
      usersList.innerHTML = "";
      snapshot.forEach(child => {
        const uid = child.key;
        const user = child.val();

        const li = document.createElement("li");
        li.textContent = user.name + (user.online ? " ✅" : " ❌");

        // 封鎖/解除封鎖按鈕
        const blockBtn = document.createElement("button");
        blockBtn.className = "small-btn";
        if(blockedUsers.includes(uid)){
          blockBtn.textContent = "解除封鎖";
          blockBtn.onclick = () => unblockUser(uid);
        } else {
          blockBtn.textContent = "封鎖";
          blockBtn.onclick = () => blockUser(uid);
        }
        li.appendChild(blockBtn);
        usersList.appendChild(li);
      });
    });
  }

  // 封鎖使用者
  function blockUser(uid){
    set(ref(db, `blockedUsers/${uid}`), true)
      .catch(err => alert("封鎖失敗：" + err.message));
  }

  // 解除封鎖
  function unblockUser(uid){
    remove(ref(db, `blockedUsers/${uid}`))
      .catch(err => alert("解除封鎖失敗：" + err.message));
  }

  // 公告欄讀取
  function loadAnnouncement(){
    const annRef = ref(db, "system/announcement");
    announcementListenerUnsub = onValue(annRef, (snapshot) => {
      const val = snapshot.val() || "";
      announcementText.value = val;
    });
  }

  // 儲存公告
  saveAnnouncementBtn.onclick = () => {
    const ann = announcementText.value.trim();
    set(ref(db, "system/announcement"), ann)
      .then(() => alert("公告儲存成功"))
      .catch(err => alert("公告儲存失敗：" + err.message));
  };

</script>
</body>
</html>
